<head>
</head>
<body>
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/vega@4.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@2.6.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@3.18.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-tooltip@0.6.1"></script>
  <div id="view"></div>
  <script>
    var vega_json = %1%;
    var plot_url = %2%;
    function updateData(view) {
      var req = new XMLHttpRequest();
      req.addEventListener("load", function() {
        var data = this.response;
        console.log(data);
        var newData = data.values.slice();
        var prevData = view.data("source_2");
        var changeSet = vega.changeset();
        if(prevData.length > 0){
          changeSet = changeSet.remove(prevData);
        }
        changeSet = changeSet.insert(newData);
        view.change("source_2", changeSet).runAfter(function(viewInstance) {
          if(data.progress != null){
            var progress = parseFloat(data.progress);
            console.log(progress);
            if(progress < 1.0) {
              setTimeout(function() {updateData(viewInstance);}, 0);
            }
          }
        });
      });
      req.responseType = "json";
      req.open("GET", plot_url);
      req.send()
    }

    vega_json.autosize = {"type": "fit", "resize": true, "contains": "padding"};

    // fixing vega tooltips
    var bubbleOpts = {
      showAllFields: true
    };
    if(vega_json["metadata"] != null){
      if(vega_json["metadata"]["bubbleOpts"] != null){
        bubbleOpts = vega_json["metadata"]["bubbleOpts"];
      }
    }

    vegaEmbed(
      '#view',
      vega_json,
      {
        "renderer": "svg"
      }
    ).then(function(result) {
        vegaTooltip.vega(result.view, bubbleOpts);

        // start data fetching
        updateData(result.view);
    });
  </script>
</body>